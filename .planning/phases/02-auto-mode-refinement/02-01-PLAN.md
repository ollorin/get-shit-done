---
phase: 02-auto-mode-refinement
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - ~/.claude/get-shit-done/bin/gsd-validator.js
  - ~/.claude/get-shit-done/bin/gsd-tools.js
  - .planning/validation/validation-log.jsonl
autonomous: true

must_haves:
  truths:
    - "Sonnet validates Haiku task output on both correctness and reasoning quality"
    - "Validation failure triggers automatic retry with Sonnet (no user confirmation)"
    - "Validation displays summary only on failure, silent on success"
    - "Tiered validation depth based on task risk level"
  artifacts:
    - path: "~/.claude/get-shit-done/bin/gsd-validator.js"
      provides: "LLM-as-a-judge validation module"
      exports: ["validateTask", "selectValidationDepth", "ValidationResult"]
    - path: ".planning/validation/validation-log.jsonl"
      provides: "Append-only validation result log"
  key_links:
    - from: "gsd-validator.js"
      to: "gsd-tools.js"
      via: "require and CLI command registration"
      pattern: "require.*gsd-validator"
    - from: "gsd-validator.js"
      to: "validation-log.jsonl"
      via: "fs.appendFileSync logging"
      pattern: "appendFileSync.*validation-log"
---

<objective>
Implement LLM-as-a-judge validation for Haiku task outputs using Sonnet as validator, with two-stage checking (correctness + reasoning quality), auto-retry on failure, and tiered validation depth.

Purpose: Ensure Haiku doesn't produce low-quality work by having Sonnet verify both output correctness and reasoning soundness before marking tasks complete (AUTO-05, AUTO-06 foundation).

Output: gsd-validator.js module with validation functions and CLI commands for validation operations.
</objective>

<execution_context>
@/Users/ollorin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ollorin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-auto-mode-refinement/02-RESEARCH.md
@.planning/phases/01-auto-mode-foundation/01-06-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create gsd-validator.js validation module</name>
  <files>~/.claude/get-shit-done/bin/gsd-validator.js</files>
  <action>
Create gsd-validator.js with these functions per user decisions:

1. **validationPrompt(task, output, reasoning)** - Generate two-stage validation prompt:
   - Correctness: "Does output meet task requirements? Bugs, missing features, incorrect logic?"
   - Reasoning quality: "Was approach sound? Shortcuts, assumptions, misunderstandings?"
   - Response format: JSON with valid, correctness_score (0-100), reasoning_score (0-100), issues[], recommendation (PASS/FIX/REDO), explanation

2. **selectValidationDepth(task)** - Risk-based tiered validation:
   - `thorough`: database, migration, schema, security, auth, payment, transaction
   - `standard`: API, integration, config, deploy
   - `light`: everything else (quick sanity check)

3. **validateTask(task, haikuOutput, haikuReasoning, options)** - Main validation function:
   - Select validation depth based on task
   - Generate and log validation prompt
   - Parse JSON response from Sonnet
   - Return ValidationResult: { valid, correctness_score, reasoning_score, issues, recommendation, explanation, depth, timestamp }

4. **logValidation(entry)** - JSONL append to .planning/validation/validation-log.jsonl:
   - Fields: timestamp, task_id, haiku_model, validator_model, depth, result, valid, correctness_score, reasoning_score, recommendation

5. **retryWithSonnet(task, validationResult)** - Auto-retry logic:
   - Called when validation fails (REDO or FIX with low scores)
   - Returns { retry_needed: boolean, new_model: 'sonnet', reason: string }

NOTE: This task creates the validation module structure. Actual Sonnet API calls will be stubbed (return mock validation) since we're building infrastructure, not integrating with live API. Integration happens in execute-plan.md.

Display logic per user decision:
- Silent on success: just return result
- Summary on failure: include displayValidationSummary() helper that formats issues for console output
  </action>
  <verify>
    - File exists: ~/.claude/get-shit-done/bin/gsd-validator.js
    - Exports validateTask, selectValidationDepth, logValidation, retryWithSonnet
    - validationPrompt generates correct two-stage prompt structure
  </verify>
  <done>
    gsd-validator.js module created with validation prompt generation, depth selection, logging, and retry logic
  </done>
</task>

<task type="auto">
  <name>Task 2: Add validation CLI commands to gsd-tools.js</name>
  <files>~/.claude/get-shit-done/bin/gsd-tools.js</files>
  <action>
Add validation subcommands to gsd-tools.js by requiring gsd-validator.js:

1. **validation validate** - Run validation on task output
   - Args: --task-id, --output (string or file path), --reasoning (string or file path)
   - Calls validateTask() and returns JSON result
   - Logs to validation-log.jsonl

2. **validation depth** - Get validation depth for task
   - Args: task description as positional
   - Returns: { depth: 'light'|'standard'|'thorough', reason: string }

3. **validation log** - Read validation log
   - Args: --task-id (optional filter), --limit (default 20)
   - Returns: array of validation entries from JSONL

4. **validation stats** - Validation statistics
   - Calculates: total validations, pass rate, average scores, by-depth breakdown
   - Returns JSON with stats

Add require for gsd-validator.js at top of gsd-tools.js:
```javascript
const validator = require('./gsd-validator');
```

Pattern follows existing subcommand structure (routing, quota).
  </action>
  <verify>
    - `node ~/.claude/get-shit-done/bin/gsd-tools.js validation depth "create user login endpoint"` returns { depth: 'thorough', reason: 'security-related task' }
    - `node ~/.claude/get-shit-done/bin/gsd-tools.js validation depth "update README"` returns { depth: 'light', reason: 'documentation task' }
  </verify>
  <done>
    CLI commands for validation operations integrated into gsd-tools.js
  </done>
</task>

<task type="auto">
  <name>Task 3: Create validation log directory and test validation flow</name>
  <files>.planning/validation/validation-log.jsonl</files>
  <action>
1. Create .planning/validation/ directory if not exists

2. Initialize validation-log.jsonl with header comment (JSON line):
   ```json
   {"_comment":"GSD validation log - Sonnet validates Haiku task outputs","created":"TIMESTAMP"}
   ```

3. Run validation test flow:
   - Call `validation depth "implement user authentication"` - expect 'thorough'
   - Call `validation depth "run test suite"` - expect 'standard'
   - Call `validation depth "fix typo in comment"` - expect 'light'

4. Verify log file structure is ready for append operations

5. Document validation command usage in validation-log.jsonl with example entry:
   ```json
   {"timestamp":"...","task_id":"test-001","depth":"thorough","valid":true,"correctness_score":95,"reasoning_score":90,"recommendation":"PASS"}
   ```
  </action>
  <verify>
    - Directory exists: .planning/validation/
    - File exists: .planning/validation/validation-log.jsonl
    - validation depth command works for all three depths
  </verify>
  <done>
    Validation log infrastructure ready, CLI commands tested for all validation depth tiers
  </done>
</task>

</tasks>

<verification>
1. gsd-validator.js module exports all required functions
2. gsd-tools.js validation subcommands work correctly
3. Validation depth selection correctly identifies risk levels
4. Validation log appends entries in JSONL format
5. Display logic shows summary only on failure (manual verification of function output)
</verification>

<success_criteria>
- validateTask() returns structured ValidationResult with correctness and reasoning scores
- selectValidationDepth() correctly categorizes tasks into light/standard/thorough
- validation CLI commands (depth, log, stats) work correctly
- Validation log captures all validation attempts in append-only JSONL
</success_criteria>

<output>
After completion, create `.planning/phases/02-auto-mode-refinement/02-01-SUMMARY.md`
</output>
