---
phase: 02-auto-mode-refinement
plan: 06
type: execute
wave: 4
depends_on: ["02-03", "02-05"]
files_modified:
  - ~/.claude/get-shit-done/workflows/execute-plan.md
  - ~/.claude/get-shit-done/bin/gsd-tools.js
autonomous: true

must_haves:
  truths:
    - "Execute-plan workflow uses validation for Haiku tasks"
    - "Circuit breakers wrap task execution with iteration/timeout limits"
    - "Error escalation triggers model upgrade on threshold breach"
    - "Feedback collection runs after task completion if enabled"
    - "End-of-execution report shows escalation history"
  artifacts:
    - path: "~/.claude/get-shit-done/workflows/execute-plan.md"
      provides: "Updated execute-plan with Phase 2 safety integration"
      contains: "validation, circuit-breaker, escalation, feedback"
  key_links:
    - from: "execute-plan.md"
      to: "gsd-validator.js"
      via: "validation step for Haiku outputs"
      pattern: "validation validate"
    - from: "execute-plan.md"
      to: "gsd-escalation.js"
      via: "error tracking and escalation"
      pattern: "escalation|ErrorTracker"
    - from: "execute-plan.md"
      to: "gsd-feedback.js"
      via: "post-task feedback collection"
      pattern: "feedback|collectFeedback"
---

<objective>
Integrate validation, circuit breakers, escalation, and feedback collection into the execute-plan workflow, creating a complete autonomous execution system with safety mechanisms.

Purpose: Tie all Phase 2 components together so auto mode safely validates Haiku work, handles errors through escalation, and learns from feedback (AUTO-05, AUTO-06, AUTO-11, AUTO-12, AUTO-13, AUTO-14 integration).

Output: Updated execute-plan.md workflow with full Phase 2 safety integration.
</objective>

<execution_context>
@/Users/ollorin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ollorin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-auto-mode-refinement/02-RESEARCH.md
@.planning/phases/02-auto-mode-refinement/02-01-PLAN.md
@.planning/phases/02-auto-mode-refinement/02-02-PLAN.md
@.planning/phases/02-auto-mode-refinement/02-03-PLAN.md
@.planning/phases/02-auto-mode-refinement/02-04-PLAN.md
@.planning/phases/02-auto-mode-refinement/02-05-PLAN.md
@.planning/phases/01-auto-mode-foundation/01-06-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update execute-plan.md with Phase 2 integration</name>
  <files>~/.claude/get-shit-done/workflows/execute-plan.md</files>
  <action>
Read current execute-plan.md and add Phase 2 safety integration:

1. **Add Phase 2 Components section** after existing auto mode section:
   ```markdown
   ## Phase 2: Safety Mechanisms

   When auto mode is active with Phase 2 features, task execution includes:

   ### Validation (Haiku tasks only)
   - After Haiku completes a task, Sonnet validates output + reasoning
   - Validation depth based on task risk: light/standard/thorough
   - If validation fails:
     - FIX recommendation → retry with targeted corrections
     - REDO recommendation → re-execute with Sonnet
   - Display: Silent on success, summary on failure

   ### Circuit Breakers
   - All tasks wrapped in circuit breaker with:
     - Iteration cap: 15 (Haiku), 20 (Sonnet), 25 (Opus)
     - Timeout: 20m (Haiku), 40m (Sonnet), 60m (Opus)
     - Adaptive adjustment for complex tasks (+50%)
   - On trip: Attempt salvage, then escalate

   ### Error Escalation
   - Weighted error scoring tracks severity
   - Threshold: 1.0 triggers escalation (1-2 errors)
   - Ladder: Haiku → Sonnet → Opus
   - Summary at end of execution (not during)

   ### Feedback Collection (if enabled)
   - After task completion, optionally prompt for feedback
   - Captures incorrect routing decisions
   - Feeds learning system for rule improvement
   ```

2. **Update task execution flow** to include safety steps:
   ```markdown
   ## Task Execution Flow (Auto Mode + Phase 2)

   For each task in plan:
   1. **Quota check** — Verify token budget (Phase 1)
   2. **Route task** — Determine model tier (Phase 1)
   3. **Create circuit breaker** — Set limits based on model/task (Phase 2)
      ```bash
      gsd-tools circuit-breaker thresholds --model $MODEL --task "$TASK_DESC"
      ```
   4. **Execute task** — Run with iteration cap
   5. **Validate (if Haiku)** — Sonnet checks output + reasoning (Phase 2)
      ```bash
      gsd-tools validation validate --task-id $ID --output "$OUTPUT"
      ```
   6. **Handle errors** — Track with ErrorTracker, escalate if needed (Phase 2)
   7. **Collect feedback (if enabled)** — Ask about model choice (Phase 2)
      ```bash
      gsd-tools feedback config  # Check if enabled
      ```
   8. **Record usage** — Update quota state (Phase 1)
   9. **Display status** — Show progress bar (Phase 1)
   ```

3. **Add end-of-execution summary section**:
   ```markdown
   ## End-of-Execution Report

   After all tasks complete (or on failure), display:

   1. **Task Summary** — Completed/failed/skipped counts
   2. **Escalation History** — If any escalations occurred
      - Task ID, from_model → to_model, reason
   3. **Validation Summary** — Pass rate, by-depth breakdown
   4. **Feedback Reminder** — If feedback enabled, prompt for batch feedback
   5. **Cost Savings** — Auto mode savings vs manual profiles
   ```

4. **Add flow diagram**:
   ```
   Task Start
       │
       ▼
   ┌─────────────┐
   │ Quota Check │ ──(exceed)──> Wait/Abort
   └─────────────┘
       │
       ▼
   ┌─────────────┐
   │ Route Task  │ ──(fallback)──> Use Sonnet
   └─────────────┘
       │
       ▼
   ┌─────────────┐
   │ Execute w/  │
   │ Circuit     │ ──(timeout)──> Salvage → Escalate
   │ Breaker     │
   └─────────────┘
       │
       ▼
   ┌─────────────┐
   │ Validate    │ (Haiku only)
   │ (Sonnet)    │ ──(fail)──> Record Error → Maybe Escalate
   └─────────────┘
       │
       ▼
   ┌─────────────┐
   │ Feedback?   │ (if enabled)
   └─────────────┘
       │
       ▼
   Task Complete
   ```
  </action>
  <verify>
    - execute-plan.md contains Phase 2 safety section
    - execute-plan.md contains updated task execution flow
    - execute-plan.md contains end-of-execution report section
    - Flow diagram shows validation → escalation → feedback path
  </verify>
  <done>
    execute-plan.md updated with complete Phase 2 safety integration documentation
  </done>
</task>

<task type="auto">
  <name>Task 2: Add orchestration helper to gsd-tools.js</name>
  <files>~/.claude/get-shit-done/bin/gsd-tools.js</files>
  <action>
Add orchestration subcommand to gsd-tools.js that combines Phase 2 operations:

1. **auto-task execute** - Execute task with full Phase 2 safety:
   - Args: --task-id, --description, --model (optional, will route if not provided)
   - Flow:
     a. Check quota (existing)
     b. Route task if model not specified (existing)
     c. Get circuit breaker thresholds
     d. Execute (stubbed - actual execution happens in workflow)
     e. If Haiku, validate output
     f. Track errors, check escalation
     g. Collect feedback if enabled
   - Returns JSON: { success, model_used, validated, escalated, feedback_collected }

2. **auto-task status** - Show Phase 2 system status:
   - Returns:
     ```json
     {
       "validation": { "enabled": true, "log_entries": 15 },
       "circuit_breaker": { "thresholds": {...}, "timeouts_logged": 2 },
       "escalation": { "total": 3, "by_model": {...} },
       "feedback": { "enabled": false, "entries": 0 },
       "learning": { "rules_count": 5, "last_merge": "..." }
     }
     ```

3. **auto-task report** - Generate end-of-execution report:
   - Args: --session-id (optional, defaults to current session)
   - Aggregates: validation stats, escalation history, feedback summary
   - Returns formatted report (text or JSON with --json flag)

This provides a single entry point for coordinators to invoke the full Phase 2 stack.
  </action>
  <verify>
    - `node ~/.claude/get-shit-done/bin/gsd-tools.js auto-task status` returns system status
    - `node ~/.claude/get-shit-done/bin/gsd-tools.js auto-task report` returns aggregated report
  </verify>
  <done>
    Orchestration helper commands added for Phase 2 integration
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify full integration and update STATE.md</name>
  <files>.planning/STATE.md</files>
  <action>
1. **Verify Phase 2 component integration**:
   - List all Phase 2 modules: gsd-validator.js, gsd-circuit-breaker.js, gsd-escalation.js, gsd-feedback.js, gsd-learning.js
   - Verify each is required in gsd-tools.js
   - Run `auto-task status` to confirm all components report

2. **Test end-to-end flow** (manual verification):
   - `validation depth "create user auth"` → thorough
   - `circuit-breaker thresholds --model haiku` → returns limits
   - `escalation simulate --errors "VALIDATION_FIX,VALIDATION_FIX"` → triggers escalation
   - `feedback config` → shows settings
   - `learning status` → shows learning state
   - `auto-task status` → shows all components

3. **Update STATE.md** with Phase 2 decisions:
   Add to Decisions section:
   - [Phase 02]: Validation uses two-stage checking (correctness + reasoning quality)
   - [Phase 02]: Circuit breaker iteration caps: 15/20/25 for Haiku/Sonnet/Opus
   - [Phase 02]: Escalation threshold: 1.0 (aggressive, prefers quality over cost)
   - [Phase 02]: Feedback feature flag disabled by default
   - [Phase 02]: Learning requires 3+ evidence count to override built-in rules

4. **Document Phase 2 completion** in STATE.md:
   - Update Current Position: Phase 2 complete
   - Add to Recent Completions table
  </action>
  <verify>
    - All 5 Phase 2 modules present in gsd-tools.js
    - auto-task status reports all components
    - STATE.md updated with Phase 2 decisions
  </verify>
  <done>
    Full Phase 2 integration verified, STATE.md updated with decisions and completion status
  </done>
</task>

</tasks>

<verification>
1. execute-plan.md documents complete Phase 2 integration
2. auto-task commands provide single entry point for orchestration
3. All Phase 2 modules (validator, circuit-breaker, escalation, feedback, learning) integrated
4. End-to-end flow testable via CLI commands
5. STATE.md reflects Phase 2 completion and key decisions
</verification>

<success_criteria>
- execute-plan.md contains validation → escalation → feedback flow
- auto-task status shows all Phase 2 components
- auto-task report generates aggregated execution summary
- STATE.md documents Phase 2 decisions and marks phase complete
</success_criteria>

<output>
After completion, create `.planning/phases/02-auto-mode-refinement/02-06-SUMMARY.md`
</output>
