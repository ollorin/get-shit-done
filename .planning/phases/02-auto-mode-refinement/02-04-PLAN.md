---
phase: 02-auto-mode-refinement
plan: 04
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - ~/.claude/get-shit-done/bin/gsd-feedback.js
  - ~/.claude/get-shit-done/bin/gsd-tools.js
  - .planning/config.json
  - .planning/feedback/human-feedback.jsonl
autonomous: true

must_haves:
  truths:
    - "Feature flag controls whether feedback prompt appears"
    - "Modes: ask human OR ask Opus (configurable)"
    - "On incorrect routing, system captures which model SHOULD have been used"
    - "Feedback is logged for learning system consumption"
  artifacts:
    - path: "~/.claude/get-shit-done/bin/gsd-feedback.js"
      provides: "Feedback collection module"
      exports: ["collectFeedback", "FeedbackResult", "isFeedbackEnabled"]
    - path: ".planning/feedback/human-feedback.jsonl"
      provides: "User feedback log for learning"
    - path: ".planning/config.json"
      provides: "Feature flag and mode configuration"
      contains: "feedback_enabled"
  key_links:
    - from: "gsd-feedback.js"
      to: ".planning/config.json"
      via: "loadConfig for feature flag"
      pattern: "loadConfig|feedback_enabled"
    - from: "gsd-feedback.js"
      to: "human-feedback.jsonl"
      via: "logFeedback append"
      pattern: "appendFileSync.*human-feedback"
---

<objective>
Implement feedback collection system with configurable modes (ask human or ask Opus), feature flag control, and structured logging of incorrect routing decisions for the learning system.

Purpose: Enable continuous improvement of model routing by capturing user corrections when the wrong model was selected (AUTO-13).

Output: gsd-feedback.js module with feedback collection, config management, and CLI commands.
</objective>

<execution_context>
@/Users/ollorin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ollorin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-auto-mode-refinement/02-RESEARCH.md
@.planning/phases/02-auto-mode-refinement/02-01-PLAN.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create feedback collection module</name>
  <files>~/.claude/get-shit-done/bin/gsd-feedback.js</files>
  <action>
Create gsd-feedback.js with these components per user decisions:

1. **loadConfig() / saveConfig()** - Load/save .planning/config.json:
   ```javascript
   const CONFIG_PATH = path.join(process.cwd(), '.planning/config.json');

   function loadConfig() {
     if (!fs.existsSync(CONFIG_PATH)) return DEFAULT_CONFIG;
     return JSON.parse(fs.readFileSync(CONFIG_PATH, 'utf-8'));
   }
   ```

2. **DEFAULT_CONFIG** structure:
   ```javascript
   const DEFAULT_CONFIG = {
     feedback_enabled: false,  // Feature flag (user decision: optional)
     feedback_mode: 'human',   // 'human' or 'opus' (user decision: configurable)
     feedback_frequency: 'escalations', // 'all', 'escalations', 'sample'
     sample_rate: 0.1  // 10% sampling if frequency is 'sample'
   };
   ```

3. **isFeedbackEnabled(config)** - Check if feedback should be collected:
   - Check config.feedback_enabled (feature flag)
   - Check frequency rules (escalations only, all, or sample)
   - Return { enabled: boolean, reason: string }

4. **collectFeedback(task, usedModel, outcome, config)** - Main feedback function:
   - If config.feedback_mode === 'human':
     - Generate prompt for CLI: "Was [model] the right choice for this task? (y/n)"
     - If 'n', ask: "Which model should have been used? (haiku/sonnet/opus)"
     - Return { correct: boolean, should_use: string|null, source: 'human' }
   - If config.feedback_mode === 'opus':
     - Generate evaluation prompt for Opus API call (stub for now)
     - Prompt includes: task description, model used, outcome, duration, errors
     - Parse JSON response: { correct_choice, should_use, reasoning }
     - Return { correct: boolean, should_use: string|null, reasoning: string, source: 'opus' }

5. **logFeedback(entry)** - Append to .planning/feedback/human-feedback.jsonl:
   - Fields: timestamp, task_id, task_description, used_model, correct, should_use, reasoning, source, outcome, duration_ms

6. **FeedbackResult type** (for TypeScript-like documentation):
   ```javascript
   // FeedbackResult: {
   //   correct: boolean,
   //   should_use: 'haiku'|'sonnet'|'opus'|null,
   //   reasoning?: string,
   //   source: 'human'|'opus',
   //   task_fingerprint: { keywords: [], complexity_signals: {} }
   // }
   ```

7. **extractTaskFingerprint(task)** - Multi-signal learning helper:
   - Extract keywords from task description
   - Calculate complexity signals (word count, technical terms, security terms)
   - Return fingerprint for pattern learning
  </action>
  <verify>
    - File exists: ~/.claude/get-shit-done/bin/gsd-feedback.js
    - Exports: collectFeedback, isFeedbackEnabled, loadConfig, saveConfig, logFeedback
    - DEFAULT_CONFIG has feedback_enabled: false (disabled by default)
  </verify>
  <done>
    Feedback collection module created with human/Opus modes, feature flag, and logging
  </done>
</task>

<task type="auto">
  <name>Task 2: Add feedback CLI commands to gsd-tools.js</name>
  <files>~/.claude/get-shit-done/bin/gsd-tools.js</files>
  <action>
Add feedback subcommands to gsd-tools.js by requiring gsd-feedback.js:

1. **feedback config** - Show current feedback configuration
   - Returns: current config with feedback_enabled, feedback_mode, frequency
   - If no config exists, shows DEFAULT_CONFIG

2. **feedback enable** - Enable feedback collection
   - Args: --mode (human|opus), --frequency (all|escalations|sample)
   - Updates .planning/config.json
   - Returns: updated config

3. **feedback disable** - Disable feedback collection
   - Sets feedback_enabled: false in config
   - Returns: confirmation message

4. **feedback log** - Read feedback log
   - Args: --correct (true|false filter), --model (filter by should_use), --limit (default 20)
   - Returns: array of feedback entries from JSONL

5. **feedback stats** - Feedback statistics
   - Calculates: total feedback, correct rate, incorrect by model, common patterns
   - Returns JSON with stats

6. **feedback prompt** - Generate feedback prompt (for testing)
   - Args: --task "task description", --model (model used)
   - Returns: the prompt that would be shown to user

Add require for gsd-feedback.js at top of gsd-tools.js:
```javascript
const feedback = require('./gsd-feedback');
```

Pattern follows existing subcommand structure.
  </action>
  <verify>
    - `node ~/.claude/get-shit-done/bin/gsd-tools.js feedback config` returns config with feedback_enabled
    - `node ~/.claude/get-shit-done/bin/gsd-tools.js feedback enable --mode human` enables feedback
    - `node ~/.claude/get-shit-done/bin/gsd-tools.js feedback prompt --task "create login endpoint" --model haiku` shows prompt
  </verify>
  <done>
    CLI commands for feedback operations integrated into gsd-tools.js
  </done>
</task>

<task type="auto">
  <name>Task 3: Initialize feedback state files and config</name>
  <files>
    .planning/feedback/human-feedback.jsonl
    .planning/config.json
  </files>
  <action>
1. Create .planning/feedback/ directory if not exists

2. Initialize human-feedback.jsonl with header:
   ```json
   {"_comment":"GSD feedback log - user corrections to model selection","created":"TIMESTAMP"}
   ```

3. Create or update .planning/config.json with feedback settings:
   - If file exists, merge feedback settings
   - If not, create with DEFAULT_CONFIG
   - Ensure feedback_enabled defaults to false (user decision: optional feature)

4. Test feedback commands:
   - `feedback config` → shows current config
   - `feedback enable --mode human` → enables with human mode
   - `feedback config` → shows feedback_enabled: true
   - `feedback disable` → disables feedback
   - `feedback config` → shows feedback_enabled: false

5. Test feedback prompt generation:
   - `feedback prompt --task "implement OAuth login" --model haiku`
   - Verify prompt asks about model correctness
   - Verify prompt includes task description

6. Document feedback workflow in config.json with comments:
   ```json
   {
     "_comment": "GSD configuration - feedback settings for model routing improvement",
     "feedback_enabled": false,
     "feedback_mode": "human",
     "feedback_frequency": "escalations"
   }
   ```
  </action>
  <verify>
    - Directory exists: .planning/feedback/
    - File exists: .planning/feedback/human-feedback.jsonl
    - File exists: .planning/config.json with feedback settings
    - feedback enable/disable commands toggle feedback_enabled
  </verify>
  <done>
    Feedback state files initialized, config management working, CLI commands tested
  </done>
</task>

</tasks>

<verification>
1. Feature flag controls feedback collection (disabled by default)
2. Both human and Opus modes are configurable
3. Feedback captures which model SHOULD have been used
4. Feedback logged with task fingerprint for pattern learning
5. CLI commands for config management work correctly
</verification>

<success_criteria>
- isFeedbackEnabled() respects feature flag and frequency settings
- collectFeedback() works in both human and Opus modes
- logFeedback() appends structured entries to JSONL
- extractTaskFingerprint() captures keywords and complexity signals
- CLI feedback commands manage config and display logs
</success_criteria>

<output>
After completion, create `.planning/phases/02-auto-mode-refinement/02-04-SUMMARY.md`
</output>
