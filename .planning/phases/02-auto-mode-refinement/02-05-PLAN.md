---
phase: 02-auto-mode-refinement
plan: 05
type: execute
wave: 3
depends_on: ["02-04"]
files_modified:
  - ~/.claude/get-shit-done/bin/gsd-learning.js
  - ~/.claude/get-shit-done/bin/gsd-tools.js
  - ~/.claude/skills/gsd-task-router/learned-rules.md
  - .planning/feedback/rule-merge-log.jsonl
autonomous: true

must_haves:
  truths:
    - "System extracts patterns from incorrect routing feedback"
    - "Learned rules merge intelligently with built-in rules"
    - "Conflict resolution applies evidence count threshold"
    - "Users can view and edit learned routing rules (transparency)"
  artifacts:
    - path: "~/.claude/get-shit-done/bin/gsd-learning.js"
      provides: "Pattern extraction and rule learning module"
      exports: ["extractPatterns", "mergeRules", "generateLearnedRulesDoc"]
    - path: "~/.claude/skills/gsd-task-router/learned-rules.md"
      provides: "Human-readable learned routing rules"
    - path: ".planning/feedback/rule-merge-log.jsonl"
      provides: "Conflict resolution decision log"
  key_links:
    - from: "gsd-learning.js"
      to: "human-feedback.jsonl"
      via: "readFeedbackLog for pattern extraction"
      pattern: "readFeedbackLog|human-feedback"
    - from: "gsd-learning.js"
      to: "learned-rules.md"
      via: "generateLearnedRulesDoc write"
      pattern: "writeFileSync.*learned-rules"
---

<objective>
Implement pattern extraction from feedback data, intelligent rule merging with conflict resolution, and user-visible learned routing rules document for transparency.

Purpose: Close the feedback loop by learning from incorrect routing decisions and improving future model selection (AUTO-14).

Output: gsd-learning.js module with pattern extraction, rule merging, and learned-rules.md generation.
</objective>

<execution_context>
@/Users/ollorin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ollorin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-auto-mode-refinement/02-RESEARCH.md
@.planning/phases/02-auto-mode-refinement/02-04-PLAN.md
@.planning/phases/01-auto-mode-foundation/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create pattern extraction and rule learning module</name>
  <files>~/.claude/get-shit-done/bin/gsd-learning.js</files>
  <action>
Create gsd-learning.js with these components per user decisions:

1. **readFeedbackLog()** - Load feedback entries from .planning/feedback/human-feedback.jsonl:
   - Filter to incorrect feedback only (correct: false)
   - Return array of feedback entries with task fingerprints

2. **extractPatterns(feedbackLog)** - Multi-signal pattern extraction (user decision):
   - For each incorrect feedback:
     - Extract keywords from task description
     - Identify pattern-based rules (e.g., "validation tasks → Sonnet")
     - Calculate complexity signals (word count, technical terms, security terms)
   - Consolidate similar patterns (group by should_use model + keyword overlap > 50%)
   - Return array of LearnedPattern:
     ```javascript
     {
       pattern: string,        // e.g., "security, authentication"
       model: string,          // should_use model
       evidence_count: number, // number of feedback entries supporting this
       keywords: string[],     // extracted keywords
       complexity_signals: {}, // word_count, has_technical, has_security
       examples: string[],     // up to 3 example task descriptions
       last_updated: string    // ISO timestamp
     }
     ```

3. **loadBuiltInRules()** - Load routing rules from Phase 1:
   - Read ~/.claude/skills/gsd-task-router/routing-rules.md
   - Parse markdown table into rule objects: { pattern, model, description }

4. **mergeRules(builtInRules, learnedRules)** - Intelligent merge (user decision):
   - For each learned rule:
     - Check for conflict (same pattern, different model)
     - If conflict AND evidence_count >= 3 → learned overrides built-in
     - If conflict AND evidence_count < 3 → keep built-in, log as insufficient evidence
     - If no conflict → add learned rule
   - Log all merge decisions to rule-merge-log.jsonl
   - Return merged rule set

5. **logRuleMerge(entry)** - Append to .planning/feedback/rule-merge-log.jsonl:
   - Fields: timestamp, pattern, conflict_type (override|insufficient|new), old_model, new_model, evidence_count

6. **EVIDENCE_THRESHOLD constant**:
   ```javascript
   const EVIDENCE_THRESHOLD = 3; // Minimum evidence to override built-in rule
   ```
  </action>
  <verify>
    - File exists: ~/.claude/get-shit-done/bin/gsd-learning.js
    - Exports: extractPatterns, mergeRules, loadBuiltInRules, readFeedbackLog, EVIDENCE_THRESHOLD
    - extractPatterns returns LearnedPattern objects with required fields
    - mergeRules respects evidence threshold for conflict resolution
  </verify>
  <done>
    Learning module created with pattern extraction, rule merging, and conflict resolution
  </done>
</task>

<task type="auto">
  <name>Task 2: Create learned rules document generator</name>
  <files>
    ~/.claude/get-shit-done/bin/gsd-learning.js
    ~/.claude/skills/gsd-task-router/learned-rules.md
  </files>
  <action>
Add to gsd-learning.js:

1. **generateLearnedRulesDoc(patterns)** - Create learned-rules.md (user decision: transparency):
   ```javascript
   function generateLearnedRulesDoc(patterns) {
     let markdown = `# Learned Routing Rules

**Generated:** ${new Date().toISOString()}
**Source:** User feedback and Opus evaluation

These rules were automatically generated from feedback on incorrect model selections.
You can edit this file to adjust rules or delete entries.

## Quick Reference

| Pattern | Model | Evidence | Last Updated |
|---------|-------|----------|--------------|
`;

     for (const pattern of patterns) {
       markdown += `| ${pattern.pattern} | ${pattern.model} | ${pattern.evidence_count} | ${pattern.last_updated.split('T')[0]} |\n`;
     }

     markdown += `\n## Pattern Details\n\n`;

     for (const pattern of patterns) {
       markdown += `### ${pattern.pattern}\n\n`;
       markdown += `- **Recommended Model:** ${pattern.model}\n`;
       markdown += `- **Evidence Count:** ${pattern.evidence_count} feedback entries\n`;
       markdown += `- **Keywords:** ${pattern.keywords.join(', ')}\n`;
       markdown += `- **Example Tasks:**\n`;
       for (const example of pattern.examples.slice(0, 3)) {
         markdown += `  - ${example}\n`;
       }
       markdown += `\n`;
     }

     return markdown;
   }
   ```

2. **writeLearnedRules(patterns)** - Write to ~/.claude/skills/gsd-task-router/learned-rules.md:
   - Generate markdown using generateLearnedRulesDoc
   - Create directory if not exists
   - Write file

3. **Initialize learned-rules.md** with empty template:
   ```markdown
   # Learned Routing Rules

   **Generated:** TIMESTAMP
   **Source:** User feedback and Opus evaluation

   These rules were automatically generated from feedback on incorrect model selections.
   You can edit this file to adjust rules or delete entries.

   ## Quick Reference

   | Pattern | Model | Evidence | Last Updated |
   |---------|-------|----------|--------------|
   | (no learned rules yet) | - | - | - |

   ## How Learning Works

   1. After task completion, you may be asked "Was this the right model?"
   2. If you answer "no", you specify which model should have been used
   3. System extracts patterns from incorrect choices
   4. After 3+ similar corrections, a learned rule is created
   5. Learned rules merge with built-in rules (Phase 1)

   To enable learning: `gsd-tools feedback enable --mode human`
   ```
  </action>
  <verify>
    - generateLearnedRulesDoc returns valid markdown
    - File exists: ~/.claude/skills/gsd-task-router/learned-rules.md
    - learned-rules.md has correct structure with table and details sections
  </verify>
  <done>
    Learned rules document generator created, initial template written
  </done>
</task>

<task type="auto">
  <name>Task 3: Add learning CLI commands and integration</name>
  <files>
    ~/.claude/get-shit-done/bin/gsd-tools.js
    .planning/feedback/rule-merge-log.jsonl
  </files>
  <action>
1. **Add learning subcommands to gsd-tools.js**:

   **learning extract** - Extract patterns from feedback
   - Calls extractPatterns(readFeedbackLog())
   - Returns: array of LearnedPattern objects
   - Useful for debugging pattern extraction

   **learning merge** - Merge learned rules with built-in
   - Loads built-in rules from routing-rules.md
   - Extracts patterns from feedback
   - Calls mergeRules()
   - Writes merged rules to learned-rules.md
   - Returns: { total_rules, learned_count, overrides, conflicts_insufficient }

   **learning rules** - Show current learned rules
   - Reads learned-rules.md
   - Parses and returns as JSON
   - Returns: array of { pattern, model, evidence_count }

   **learning clear** - Clear learned rules
   - Resets learned-rules.md to empty template
   - Returns: confirmation message

   **learning status** - Learning system status
   - Returns: { feedback_count, incorrect_count, learned_rules_count, last_merge }

2. **Initialize rule-merge-log.jsonl**:
   ```json
   {"_comment":"GSD rule merge log - conflict resolution decisions","created":"TIMESTAMP"}
   ```

3. **Add require for gsd-learning.js**:
   ```javascript
   const learning = require('./gsd-learning');
   ```

4. **Test learning flow**:
   - `learning status` → shows current state
   - `learning extract` → returns empty if no feedback
   - `learning merge` → merges rules (even if empty feedback)
   - `learning rules` → shows learned-rules.md content
  </action>
  <verify>
    - `node ~/.claude/get-shit-done/bin/gsd-tools.js learning status` returns learning state
    - `node ~/.claude/get-shit-done/bin/gsd-tools.js learning rules` returns parsed rules
    - File exists: .planning/feedback/rule-merge-log.jsonl
    - learning merge writes to learned-rules.md
  </verify>
  <done>
    Learning CLI commands integrated, rule merge log initialized, full learning flow tested
  </done>
</task>

</tasks>

<verification>
1. Pattern extraction identifies keywords and complexity signals from feedback
2. Rule merging respects evidence threshold (3+ for override)
3. Conflict resolution logs decisions to rule-merge-log.jsonl
4. learned-rules.md is human-readable and editable (transparency)
5. Learning CLI commands enable full learning workflow
</verification>

<success_criteria>
- extractPatterns() consolidates similar feedback into LearnedPattern objects
- mergeRules() correctly handles conflicts based on evidence count
- generateLearnedRulesDoc() produces readable markdown with table and details
- CLI commands enable pattern extraction, rule merging, and status checking
- Users can view and edit learned-rules.md directly (transparency)
</success_criteria>

<output>
After completion, create `.planning/phases/02-auto-mode-refinement/02-05-SUMMARY.md`
</output>
