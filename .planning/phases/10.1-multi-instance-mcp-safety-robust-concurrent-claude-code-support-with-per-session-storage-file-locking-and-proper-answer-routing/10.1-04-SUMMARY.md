---
phase: 10.1-multi-instance-mcp-safety
plan: 04
subsystem: telegram-ui
tags: [multi-session-routing, telegram-bot, session-labels, answer-routing, gitignore]

# Dependency graph
requires:
  - phase: 10.1-03
    provides: Session-aware MCP tools and lifecycle management
provides:
  - Multi-session Telegram UI with button-based answer routing
  - Session label display in question list for identification
  - Auto-match convenience for single pending question
  - Gitignore rules for session files and archive
affects: [telegram-notifications, user-interface, multi-instance-operation]

# Tech tracking
tech-stack:
  patterns: [multi-session-ui, button-callback-routing, session-label-display]

key-files:
  created:
    - .planning/.gitignore
  modified:
    - mcp-servers/telegram-mcp/src/bot/telegram-bot.ts

key-decisions:
  - "Button callback format: answer:<sessionId>:<questionId> for session routing"
  - "Session labels shown in question list: [label] or [session-id-prefix]"
  - "Auto-match still works for single pending question (convenience)"
  - "Session files and archive directory gitignored for runtime data"
  - "loadAllPendingQuestions used by bot, loadPendingQuestions(sessionId) by tools"

patterns-established:
  - "Multi-session UI pattern: count sessions, show labels, route to correct file"
  - "Dual routing modes: explicit (button-selected) and auto-match (single pending)"
  - "Session identification: metadata.label || sessionId.slice(0,8)"

# Metrics
duration: 3min
completed: 2026-02-17
---

# Phase 10.1 Plan 04: Multi-Session Telegram UI and Gitignore Summary

**Telegram bot now handles questions from multiple concurrent Claude Code instances with session-aware routing**

## Performance

- **Duration:** 3 minutes
- **Started:** 2026-02-17T16:23:18Z
- **Completed:** 2026-02-17T16:26:19Z
- **Tasks:** 2
- **Files modified:** 2

## Accomplishments
- Updated Telegram bot to load questions from all active sessions via loadAllPendingQuestions
- Added session label or ID prefix to question list for user identification
- Updated button callback format to include both session ID and question ID
- Modified answer button handler to extract and store session ID
- Updated text and voice message handlers to use session-scoped markAnswered(sessionId, questionId, answer)
- Maintained auto-match behavior for single pending question (zero overhead)
- Added awaitingSessionId field to SessionData interface
- Created .planning/.gitignore to exclude session runtime data
- Configured gitignore rules for *.jsonl files, lock files, and archive directory
- Excluded legacy telegram-questions/ and telegram-queue/ directories

## Task Commits

Each task was committed atomically:

1. **Task 1: Update Telegram bot for multi-session question routing** - `15b9660` (feat)
2. **Task 2: Configure gitignore for session files and archive** - `f7322c9` (feat)

## Files Created/Modified
- `mcp-servers/telegram-mcp/src/bot/telegram-bot.ts` - Multi-session UI with loadAllPendingQuestions, session labels, answer:<sessionId>:<questionId> routing
- `.planning/.gitignore` - Gitignore rules for telegram-sessions/*.jsonl, archive/, lock files, and legacy directories

## Decisions Made

**1. Button callback format includes session ID**
- Rationale: Enables routing answer to the correct session file when multiple instances have pending questions

**2. Session labels displayed in question list**
- Rationale: User can identify which Claude Code instance asked the question (especially useful for labeled sessions like "feature-auth")

**3. Auto-match preserved for single pending question**
- Rationale: Zero overhead for single-instance operation, maintains user convenience

**4. Session files gitignored**
- Rationale: Runtime data shouldn't be committed, but directory structure should be trackable

**5. loadAllPendingQuestions for bot, loadPendingQuestions(sessionId) for tools**
- Rationale: Bot needs cross-session visibility, tools need session isolation

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None - all tasks completed successfully with no blocking issues.

## User Setup Required

None - changes are fully backward compatible. Single-instance operation has zero overhead (auto-match still works). Multi-instance operation shows session labels for clarity.

## Next Phase Readiness

Phase 10.1 is now complete. Multi-instance MCP safety system is fully operational:
- ✅ Session lifecycle management with heartbeat
- ✅ File locking prevents concurrent write corruption
- ✅ Per-session question storage with UUID identifiers
- ✅ Session-aware MCP tools (ask, check, mark)
- ✅ Multi-session Telegram UI with answer routing

**System Validation:**
- Multiple Claude Code instances can run concurrently
- Each instance operates in isolated session
- Questions are properly scoped to sessions
- User sees all pending questions with session identification
- Answers route to correct session file
- Single-instance operation maintains zero overhead

**Blockers:** None

**Validation:**
- ✅ TypeScript compiles full telegram-mcp project without errors
- ✅ npm run build succeeds
- ✅ Button callback data format: answer:<sessionId>:<questionId>
- ✅ SessionData interface has awaitingSessionId field
- ✅ markAnswered calls include sessionId parameter
- ✅ loadAllPendingQuestions used for cross-session question listing
- ✅ .planning/.gitignore exists with session-related rules
- ✅ Session files properly excluded from git tracking

## Self-Check: PASSED

Verified claims:
- ✅ Created files: .planning/.gitignore
- ✅ Modified files: mcp-servers/telegram-mcp/src/bot/telegram-bot.ts
- ✅ Commits exist: 15b9660 (Task 1), f7322c9 (Task 2)
- ✅ TypeScript compilation successful: `npx tsc --noEmit` passes
- ✅ Build successful: `npm run build` passes
- ✅ Button callback includes session ID: `answer:${q.session_id}:${q.id}`
- ✅ SessionData has awaitingSessionId: field declared in interface
- ✅ markAnswered uses sessionId: all calls pass (sessionId, questionId, answer)
- ✅ loadAllPendingQuestions imported and used: verified in bot file
- ✅ Session labels shown: `[${label}]` in button text
- ✅ Gitignore rules exist: .planning/.gitignore created

---
*Phase: 10.1-multi-instance-mcp-safety*
*Completed: 2026-02-17*
