---
phase: 10.1-multi-instance-mcp-safety
plan: 01
subsystem: infra
tags: [file-locking, session-management, proper-lockfile, uuid, jsonl, concurrency]

# Dependency graph
requires:
  - phase: 08.1-telegram-mcp-server
    provides: question-queue.ts and storage infrastructure patterns
provides:
  - File locking abstraction with exponential backoff retry
  - Session lifecycle management (create, discover, cleanup, archive, heartbeat)
  - Dual stale session detection (PID + heartbeat TTL)
  - Self-healing JSONL reader with corruption tolerance
  - Per-session JSONL storage in .planning/telegram-sessions/
affects: [10.1-02, 10.1-03, 10.1-04, multi-instance-safety, question-routing]

# Tech tracking
tech-stack:
  added: [proper-lockfile@4.1.2, uuid@13.0.0]
  patterns: [file-locking-with-retry, session-lifecycle, self-healing-jsonl, dual-staleness-detection]

key-files:
  created:
    - mcp-servers/telegram-mcp/src/storage/file-lock.ts
    - mcp-servers/telegram-mcp/src/storage/session-manager.ts
  modified:
    - mcp-servers/telegram-mcp/package.json
    - package-lock.json

key-decisions:
  - "Use proper-lockfile instead of custom locking for production-ready file protection"
  - "PID check via process.kill(pid, 0) instead of process-exists package for simplicity"
  - "24-hour heartbeat TTL balances cleanup speed with session persistence"
  - "10% corruption threshold triggers warnings in self-healing JSONL reader"
  - "Opportunistic cleanup on session creation prevents stale session buildup"
  - "Date-based archive folders (YYYY-MM-DD) enable organized historical session storage"

patterns-established:
  - "withLock pattern: wrap all concurrent file operations with file-lock.ts"
  - "Dual detection pattern: combine PID existence check with heartbeat freshness"
  - "Self-healing JSONL: parse line-by-line, skip corrupted entries, warn on high corruption"
  - "Opportunistic cleanup: trigger on create but don't block on errors"

# Metrics
duration: 2min
completed: 2026-02-17
---

# Phase 10.1 Plan 01: Session Infrastructure Summary

**File locking with proper-lockfile and session lifecycle management with dual stale detection (PID + heartbeat TTL)**

## Performance

- **Duration:** 2 minutes
- **Started:** 2026-02-17T16:00:04Z
- **Completed:** 2026-02-17T16:02:22Z
- **Tasks:** 2
- **Files modified:** 4

## Accomplishments
- File locking module with exponential backoff retry strategy (100ms, 200ms, 400ms)
- Session manager with complete lifecycle: create, discover, cleanup, archive, heartbeat, close
- Dual stale session detection combining PID existence and heartbeat TTL
- Self-healing JSONL reader tolerating up to 10% corrupted lines

## Task Commits

Each task was committed atomically:

1. **Task 1: Install dependencies and create file locking module** - `e371460` (feat)
2. **Task 2: Create session manager with lifecycle operations** - `83f6ab5` (feat)

## Files Created/Modified
- `mcp-servers/telegram-mcp/src/storage/file-lock.ts` - File locking abstraction with exponential backoff (3 retries at 100ms, 200ms, 400ms)
- `mcp-servers/telegram-mcp/src/storage/session-manager.ts` - Session lifecycle management with dual stale detection
- `mcp-servers/telegram-mcp/package.json` - Added proper-lockfile@4.1.2 and uuid@13.0.0 dependencies
- `package-lock.json` - Locked dependency versions

## Decisions Made

**1. Use proper-lockfile instead of custom locking**
- Rationale: Production-ready, battle-tested, handles edge cases (stale locks, process crashes)

**2. PID check via process.kill(pid, 0) instead of process-exists package**
- Rationale: Simpler, no extra dependency, works natively on macOS/Linux, signal 0 = existence check

**3. 24-hour heartbeat TTL**
- Rationale: Balances cleanup speed (doesn't leave stale sessions forever) with persistence (survives overnight sessions)

**4. 10% corruption threshold for JSONL warnings**
- Rationale: Occasional corruption tolerated, but >10% indicates systemic problem worth investigating

**5. Opportunistic cleanup on session creation**
- Rationale: Prevents stale session buildup without requiring background cron jobs

**6. Date-based archive folders (YYYY-MM-DD)**
- Rationale: Organized historical storage, enables easy retention policy (delete folders older than N days)

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

**TypeScript compilation error on single-file verification**
- **Issue:** `npx tsc --noEmit src/storage/session-manager.ts` failed with module import errors
- **Cause:** Testing single file without tsconfig context (esModuleInterop not applied)
- **Resolution:** Compiled entire project with `npx tsc --noEmit`, which succeeded using tsconfig.json settings
- **Impact:** Verification method adjusted, no code changes needed

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

Session infrastructure complete and ready for integration:
- Plan 10.1-02 can refactor question-queue.ts to use session manager
- Plan 10.1-03 can implement answer routing with session awareness
- File locking ensures safe concurrent access across all future MCP operations

**Blockers:** None

**Validation:**
- ✅ proper-lockfile and uuid installed and verified
- ✅ file-lock.ts exports withLock function
- ✅ session-manager.ts exports all 10 functions + SESSIONS_DIR constant
- ✅ TypeScript compiles entire telegram-mcp project without errors
- ✅ All task changes committed atomically with proper messages

## Self-Check: PASSED

Verified claims:
- ✅ Created files exist: file-lock.ts (2.2K), session-manager.ts (7.9K)
- ✅ Commits exist: e371460, 83f6ab5
- ✅ Dependencies installed: proper-lockfile@4.1.2, uuid@13.0.0
- ✅ TypeScript compilation successful: `npx tsc --noEmit` passes

---
*Phase: 10.1-multi-instance-mcp-safety*
*Completed: 2026-02-17*
